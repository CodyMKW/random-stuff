<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CodyBoy Advance ‚Äî EmulatorJS GBA (Maple build)</title>
<link rel="icon" href="data:,üéÆ" />
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1720; --accent:#ff6b6b; --muted:#9aa5b1;
    --glass: rgba(255,255,255,0.04);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    background:
      radial-gradient(1200px 400px at 10% 10%, rgba(255,107,107,0.06), transparent 8%),
      linear-gradient(180deg,#071018 0%, #071623 45%, #051018 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
    padding:24px;
    box-sizing:border-box;
  }
  header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;background:linear-gradient(135deg,#ff9a9e,#fecfef);border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#111}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .layout{display:grid;grid-template-columns: 420px 1fr; gap:20px; align-items:start;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px;padding:14px;box-shadow: 0 6px 18px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
  .controls .section{margin-bottom:12px}
  .dropzone{border:2px dashed rgba(255,255,255,0.04);padding:18px;border-radius:10px;text-align:center;cursor:pointer;background:var(--glass);}
  .muted{color:var(--muted);font-size:13px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;background:linear-gradient(90deg,var(--accent),#ffa77a);color:#07201a;font-weight:600;border:none;cursor:pointer;}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
  .flex{display:flex;gap:8px;align-items:center}
  .kbd{font-family:monospace;background:rgba(255,255,255,0.03);border-radius:6px;padding:6px 8px;font-size:12px;color:var(--muted)}
  .small{font-size:13px}
  #gameWrap{width:100%;height:520px;background:#000;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative}
  #game{width:100%;height:100%;}
  .meta{display:flex;justify-content:space-between;margin-top:10px;gap:8px;align-items:center}
  .info{color:var(--muted);font-size:13px}
  .slots{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .slot{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center;font-size:13px}
  .slot .title{font-weight:700;color:#fff}
  .save-list{max-height:160px;overflow:auto;padding:6px;border-radius:8px;border:1px dashed rgba(255,255,255,0.02)}
  label.fileish{display:inline-block;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  .unhinge{ position:absolute; right:14px; top:12px; font-size:12px; color: #071018; background: #ffdede; padding:6px 8px; border-radius:20px; transform: rotate(-6deg); box-shadow: 0 6px 12px rgba(0,0,0,0.3)}
  .mapping{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:8px}
  .mapping .row{display:flex;justify-content:space-between;padding:6px;background:rgba(255,255,255,0.01);border-radius:6px;font-size:13px}
  .touchpad{display:none}
  @media (max-width:1100px){
    .layout{grid-template-columns:1fr; }
    #gameWrap{height:420px}
    .touchpad{display:block;margin-top:8px}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">CBA</div>
    <div>
      <h1>CodyBoy Advance ‚Äî EmulatorJS (Maple build)</h1>
      <p class="lead">Pok√©mon-friendly saves ‚Ä¢ Drag & Drop ROMs ‚Ä¢ Save-States ‚Ä¢ Pro controls</p>
    </div>
  </div>
  <div style="margin-left:auto;text-align:right">
    <div class="muted">Powered by <strong>EmulatorJS</strong></div>
    <div style="font-size:12px;color:var(--muted)">CDN: stable ‚Ä¢ Core: mGBA</div>
  </div>
</header>

<div class="layout">
  <!-- LEFT: Controls -->
  <div class="card controls">
    <div class="section">
      <div class="dropzone" id="dropzone" tabindex="0">
        <div style="font-size:14px;font-weight:700">Drop a .gba ROM here</div>
        <div class="muted" style="margin-top:8px">Or click to choose ‚Äî supports drag & drop, and will keep your saves local.</div>
        <input id="romPicker" accept=".gba,.zip" type="file" style="display:none">
      </div>
    </div>

    <div class="section">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:700">Game Status</div>
          <div class="muted small" id="status">No game loaded</div>
        </div>
        <div>
          <button class="btn ghost" id="restartBtn">Restart</button>
          <button class="btn ghost" id="pauseBtn">Pause</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Battery Save</div>
        <div class="muted small">Pok√©mon-friendly</div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn" id="exportSaveBtn">Export Latest Save</button>
        <label class="fileish">
          Import Save <input id="importSave" type="file" accept=".sav" style="display:none" />
        </label>
      </div>
      <div class="muted small">If the emulator writes a battery save, this panel will show it and allow export.</div>
      <div style="margin-top:8px" id="savePreview"></div>
    </div>

    <div class="section">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Save States (download / restore)</div>
        <div class="muted small">Quick download slots</div>
      </div>

      <div class="slots" id="slots">
        <!-- slots injected -->
      </div>
      <div style="margin-top:8px" class="muted small">Use the built-in emulator controls to create a save state (or use emulator UI). When a save-state is created, you'll be invited to download it here.</div>
    </div>

    <div class="section">
      <div style="font-weight:700;margin-bottom:6px">Controls & Mapping</div>
      <div class="mapping" id="mapping">
        <div class="row"><div>A</div><div class="kbd">Z / X / Gamepad A</div></div>
        <div class="row"><div>B</div><div class="kbd">X / C / Gamepad B</div></div>
        <div class="row"><div>Select</div><div class="kbd">V / Gamepad Select</div></div>
        <div class="row"><div>Start</div><div class="kbd">Enter / Gamepad Start</div></div>
        <div class="row"><div>Up/Down/Left/Right</div><div class="kbd">Arrow keys / D-pad</div></div>
        <div class="row"><div>Quick Save</div><div class="kbd">F5</div></div>
        <div class="row"><div>Quick Load</div><div class="kbd">F8</div></div>
        <div class="row"><div>Screen Shot</div><div class="kbd">Ctrl+S</div></div>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:700;margin-bottom:6px">Touch Controls</div>
      <div class="touchpad">
        <div class="muted small">For phones, an on-screen gamepad will appear automatically. You can also toggle it with the emulator UI.</div>
      </div>
    </div>

    <div class="section">
      <div style="font-weight:700">Advanced</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="dumpSaves" class="btn ghost">List cached saves</button>
        <button id="clearCache" class="btn ghost">Clear cached files</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: Game viewport -->
  <div>
    <div class="card">
      <div style="position:relative;">
        <div id="gameWrap">
          <div class="unhinge">üçÅ Maple Edition</div>
          <div id="game"></div>
          <!-- EmulatorJS will mount into #game -->
        </div>
      </div>

      <div class="meta">
        <div class="info">
          <div><strong id="gameTitle">‚Äî</strong></div>
          <div class="muted" id="gameMeta">Core: gba ‚Ä¢ CDN: stable</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <div style="font-size:13px;color:var(--muted)">FPS: <span id="fps">‚Äî</span></div>
          <div style="font-size:13px;color:var(--muted)">Status: <span id="runState">idle</span></div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="font-weight:700;margin-bottom:8px">Save / State Activity</div>
        <div class="save-list" id="activityLog">No save activity yet.</div>
      </div>

    </div>

    <footer>
      Mapled by Maple ‚Ä¢ EmulatorJS CDN + mGBA core. Read the docs for advanced embed options and servers. (This page streams emulator binaries from the official CDN.) 
    </footer>
  </div>
</div>

<script>
const CDN_BASE = 'https://cdn.emulatorjs.org/stable/data/';
const LOADER_URL = CDN_BASE + 'loader.js';
let latestBatterySave = null;
let saveStateSlots = new Array(10).fill(null);

/* --- important save fix --- */
function persistSaveToLocal(hash, buf, name){
  try {
    localStorage.setItem("CBA_sav_" + hash, JSON.stringify({
      ts: Date.now(),
      name,
      b64: btoa(String.fromCharCode(...new Uint8Array(buf)))
    }));
  } catch(e){ console.warn("localStorage save failed", e); }
}
function loadSaveFromLocal(hash){
  const raw = localStorage.getItem("CBA_sav_" + hash);
  if(!raw) return null;
  try {
    const obj = JSON.parse(raw);
    const bin = Uint8Array.from(atob(obj.b64), c => c.charCodeAt(0));
    return {data: bin, name: obj.name};
  } catch(e){ return null; }
}

/* hook for EmulatorJS */
window.EJS_onSaveUpdate = function(payload){
  latestBatterySave = {
    hash: payload.hash,
    save: payload.save,
    name: (window._progba_lastName || 'game') + ".sav"
  };
  persistSaveToLocal(payload.hash, payload.save, latestBatterySave.name);
  console.log("Battery save updated + persisted", latestBatterySave.name);
};
window.EJS_ready = function(){
  const h = window.EJS_gameHash;
  const local = loadSaveFromLocal(h);
  if(local && window.EJS_module && window.EJS_module.writeSaveFiles){
    window.EJS_module.writeSaveFiles([{name: local.name, data: local.data}])
      .then(()=> console.log("Restored save from localStorage"))
      .catch(console.warn);
  }
};
/* --- end save fix --- */

/* load ROM normally */
function loadRomFile(file){
  const romUrl = URL.createObjectURL(file);
  window._progba_lastName = file.name.replace(/\.[^/.]+$/,"");
  window.EJS_player = "#game";
  window.EJS_core = "gba";
  window.EJS_gameUrl = romUrl;
  window.EJS_pathtodata = CDN_BASE;
  window.EJS_startOnLoaded = true;
  const s = document.createElement("script");
  s.src = LOADER_URL + "?_=" + Date.now();
  document.body.appendChild(s);
}
</script>
</body>
</html>
