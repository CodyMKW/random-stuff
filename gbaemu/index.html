<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GBA Emulator - Nintendo's Finest, In Your Browser</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #1a1a1a;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #ff6b35;
      text-align: center;
      margin-bottom: 10px;
    }
    .controls-section {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      width: 100%;
      max-width: 640px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .controls-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .controls-table th, .controls-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #404040;
    }
    .controls-table th {
      background: #ff6b35;
      color: #000;
    }
    #emulator-container {
      width: 640px;
      height: 480px;
      max-width: 100%;
      background: #000;
      border: 2px solid #ff6b35;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    button {
      background: #ff6b35;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    button:hover {
      background: #e55a2b;
    }
    #game {
      width: 100%;
      height: 100%;
    }
    .note {
      text-align: center;
      font-size: 0.9em;
      color: #888;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Game Boy Advance Emulator</h1>
  <p class="note">The handheld that Xbox wishes it could be. Load your ROM and pretend you're outdoors.</p>
  
  <div class="controls-section">
    <h2>Controls</h2>
    <table class="controls-table">
      <thead>
        <tr>
          <th>GBA Button</th>
          <th>Keyboard</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>D-Pad Up</td><td>↑ Arrow</td></tr>
        <tr><td>D-Pad Down</td><td>↓ Arrow</td></tr>
        <tr><td>D-Pad Left</td><td>← Arrow</td></tr>
        <tr><td>D-Pad Right</td><td>→ Arrow</td></tr>
        <tr><td>A Button</td><td>Z</td></tr>
        <tr><td>B Button</td><td>X</td></tr>
        <tr><td>L Trigger</td><td>A</td></tr>
        <tr><td>R Trigger</td><td>S</td></tr>
        <tr><td>Start</td><td>Enter</td></tr>
        <tr><td>Select</td><td>\ (Backslash)</td></tr>
      </tbody>
    </table>
    <p class="note">Full-screen? F11. Volume? Your speakers aren't trash, are they?</p>
  </div>
  
  <div>
    <button id="load-rom">Load GBA ROM</button>
    <button id="download-save">Download Save</button>
    <button id="upload-save">Upload Save</button>
    <button id="save-state">Save State</button>
    <button id="load-state">Load State</button>
  </div>
  
  <div id="emulator-container">
    <div id="game"></div>
  </div>
  
  <script type="text/javascript">
    EJS_player = '#game';
    EJS_core = 'mgba';
    EJS_biosUrl = 'gba-bios.bin';
    EJS_pathtodata = 'data/';
    EJS_autoSave = true; // Enable autosave for SRAM
    let currentGameId = null;

    // --- Base64 helpers ---
    function b64Encode(bytes) {
      let binary = "";
      for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }
    function b64Decode(b64) {
      const binary = atob(b64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    // Load ROM
    document.getElementById('load-rom').addEventListener('click', function () {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.gba,.zip';
      input.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          const url = URL.createObjectURL(file);
          currentGameId = file.name.replace(/\.[^/.]+$/, "");
          EJS_gameUrl = url;
          EJS_gameID = currentGameId;

          // SRAM hooks
          EJS_onSaveSRAM = function (saveBytes) {
            localStorage.setItem("EJS_" + currentGameId + "_sram", b64Encode(saveBytes));
          };
          EJS_onLoadSRAM = function () {
            const data = localStorage.getItem("EJS_" + currentGameId + "_sram");
            return data ? b64Decode(data) : null;
          };

          document.querySelector('#game').innerHTML = '';
          if (typeof EJS_start !== 'undefined') {
            EJS_start();
          } else {
            const script = document.createElement('script');
            script.src = 'data/loader.js';
            script.onload = function () {
              EJS_start();
            };
            document.head.appendChild(script);
          }
        }
      };
      input.click();
    });

    // Download Save
    document.getElementById('download-save').addEventListener('click', function () {
      if (!currentGameId) return alert("No game loaded!");
      const key = "EJS_" + currentGameId + "_sram";
      const saveData = localStorage.getItem(key);
      if (saveData) {
        const bytes = b64Decode(saveData);
        const blob = new Blob([bytes], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentGameId + ".sav";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } else {
        alert("No save found for this game!");
      }
    });

    // Upload Save
    document.getElementById('upload-save').addEventListener('click', function () {
      if (!currentGameId) return alert("Load a game before uploading a save!");
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.sav';
      input.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (event) {
            const bytes = new Uint8Array(event.target.result);
            localStorage.setItem("EJS_" + currentGameId + "_sram", b64Encode(bytes));
            alert("Save uploaded! Reload the ROM to apply it.");
          };
          reader.readAsArrayBuffer(file);
        }
      };
      input.click();
    });

    // Save State
    document.getElementById('save-state').addEventListener('click', async function () {
      if (!currentGameId || typeof EJS_emulator === 'undefined') return alert("No game running!");
      const state = await EJS_emulator.saveState();
      localStorage.setItem("EJS_" + currentGameId + "_state", b64Encode(state));
      alert("State saved!");
    });

    // Load State
    document.getElementById('load-state').addEventListener('click', async function () {
      if (!currentGameId || typeof EJS_emulator === 'undefined') return alert("No game running!");
      const data = localStorage.getItem("EJS_" + currentGameId + "_state");
      if (data) {
        await EJS_emulator.loadState(b64Decode(data));
        alert("State loaded!");
      } else {
        alert("No state found!");
      }
    });

    // Force save on unload (backup safety)
    window.addEventListener('beforeunload', () => {
      if (typeof EJS_emulator !== 'undefined' && currentGameId) {
        try {
          const sram = EJS_emulator.SRAM;
          if (sram) {
            localStorage.setItem("EJS_" + currentGameId + "_sram", b64Encode(sram));
          }
        } catch (e) {
          console.warn("Could not save SRAM on unload", e);
        }
      }
    });
  </script>

  <script src="data/loader.js"></script>
</body>
</html>
