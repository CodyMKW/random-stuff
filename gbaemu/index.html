<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maple's GBAcade — Cody Edition</title>
  <meta name="description" content="Maple's GBAcade — Browser Game Boy Advance emulator powered by EmulatorJS CDN" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%2300BFA5'/%3E%3Ctext x='50' y='58' font-size='36' text-anchor='middle' fill='white' font-family='Arial' %3EM%3C/text%3E%3C/svg%3E">
  <style>
    /* Minimal, modern, professional layout */
    :root{
      --accent:#1aafff;
      --bg:#0f1720;
      --card:#0b1220;
      --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      --shadow: 0 6px 20px rgba(2,6,23,0.6);
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    html,body{height:100%;margin:0;background:
      linear-gradient(180deg,#071021 0%, #071827 55%, #00121a 100%);
      color:#e6eef6;}
    .wrap{
      max-width:1200px;margin:28px auto;padding:18px;
      display:grid;grid-template-columns: 420px 1fr;gap:18px;
    }
    header{grid-column:1/-1;display:flex;align-items:center;gap:16px}
    .logo{
      width:72px;height:72px;border-radius:14px;background:linear-gradient(135deg,var(--accent),#00d4b0);
      display:flex;align-items:center;justify-content:center;font-weight:700;font-size:28px;color:#002;
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
    }
    h1{margin:0;font-size:20px}
    .subtitle{font-size:12px;color:var(--muted);margin-top:4px}

    /* Left panel: controls */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); border:1px solid rgba(255,255,255,0.03);
    }
    .drop{
      border: 2px dashed rgba(255,255,255,0.04); border-radius:10px;padding:18px;text-align:center;
      min-height:112px; display:flex;flex-direction:column;align-items:center;justify-content:center; gap:8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.005), transparent);
      color:var(--muted);
    }
    .btn{
      background:linear-gradient(180deg,var(--accent),#00c1ff);
      border:none;color:#002;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;
      box-shadow: 0 8px 18px rgba(10,40,80,0.35);
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);box-shadow:none}
    .row{display:flex;gap:8px;margin-top:12px;align-items:center}
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="file"]{display:none}
    .control-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
    .kbd{background:var(--glass);padding:8px;border-radius:8px;font-size:13px;color:var(--muted);text-align:center}

    /* Right panel: emulator area */
    .canvas-wrap{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius:var(--radius); padding:12px; box-shadow:var(--shadow); display:flex;flex-direction:column;height:720px;
      min-height:420px; gap:12px; border:1px solid rgba(255,255,255,0.03);
    }
    .game-area{flex:1;display:flex;align-items:center;justify-content:center; background: #05070a;border-radius:10px; overflow:hidden; position:relative;}
    /* #game will be injected there by EmulatorJS */
    #game{width:100%;height:100%;display:flex;align-items:center;justify-content:center}

    .toolbar{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}

    footer.small{grid-column:1/-1;margin-top:8px;color:var(--muted);font-size:12px;text-align:center}

    /* Touch virtual pad hints */
    .touch-hint{position:absolute;right:12px;bottom:12px;background:rgba(0,0,0,0.35);padding:8px;border-radius:10px;color:var(--muted);font-size:12px}

    @media (max-width:980px){
      .wrap{grid-template-columns:1fr; padding:12px}
      .canvas-wrap{height:66vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">M</div>
      <div>
        <h1>Maple's GBAcade — Cody Edition</h1>
        <div class="subtitle">Browser GBA emulator (powered by EmulatorJS CDN). Load your own ROM. No ROMs/BIOS included.</div>
      </div>
    </header>

    <!-- LEFT: controls -->
    <aside class="panel" aria-labelledby="controls-heading">
      <h3 id="controls-heading" style="margin:0 0 8px 0">Load & Controls</h3>

      <div class="drop" id="dropzone">
        <div style="font-weight:700;color:#cbeefe">Drag & Drop your .gba here</div>
        <div class="muted">or click <button class="btn ghost" id="pickBtn">Browse</button> to select a ROM file</div>
        <div class="muted" id="selectedName" style="margin-top:6px">No ROM selected</div>
        <input id="fileIn" type="file" accept=".gba,.zip,.7z,.bin,.rom" />
      </div>

      <div class="row">
        <div style="flex:1">
          <label class="small">Volume</label>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="0.75" />
        </div>
        <div style="width:110px">
          <label class="small">Speed</label>
          <select id="speed" class="kbd" style="width:100%">
            <option value="1">1× (normal)</option>
            <option value="1.5">1.5×</option>
            <option value="2">2×</option>
            <option value="0.5">0.5× (slow)</option>
          </select>
        </div>
      </div>

      <div class="control-grid">
        <button id="loadBtn" class="btn">Start Game</button>
        <button id="fullscreenBtn" class="btn ghost">Fullscreen</button>
        <button id="screenshotBtn" class="btn ghost">Screenshot</button>
        <button id="openUiBtn" class="btn ghost">Open Emulator UI</button>
      </div>

      <div style="margin-top:12px">
        <div class="small muted" style="margin-bottom:8px">Keyboard mapping (default)</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <div class="kbd">A = Z</div>
          <div class="kbd">B = X</div>
          <div class="kbd">L = A</div>
          <div class="kbd">R = S</div>
          <div class="kbd">Start = Enter</div>
          <div class="kbd">Select = \</div>
          <div class="kbd">D-pad = Arrow keys</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong style="font-size:13px">Quick tips</strong>
        <ul class="muted" style="padding-left:18px;margin:8px 0 0 0;line-height:1.5">
          <li>Use a gamepad — emulator supports gamepads (open settings to map).</li>
          <li>Save states & screenshots are available in the emulator UI.</li>
          <li>If a ROM needs BIOS, upload it when prompted by the emulator.</li>
        </ul>
      </div>

      <div style="margin-top:12px" class="muted">
        <strong>Legal: </strong>Maple's GBAcade doesn't include games or BIOS. Only load ROMs that you legally own.
      </div>
    </aside>

    <!-- RIGHT: emulator -->
    <main class="canvas-wrap panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="toolbar">
          <div class="muted" id="gameTitle">No game loaded</div>
        </div>
        <div>
          <span class="muted" style="margin-right:8px">Status:</span><span class="muted" id="status">idle</span>
        </div>
      </div>

      <div class="game-area" id="gameArea">
        <div id="game">Select a ROM and click "Start Game" — Maple thinks you'll love this one.</div>
        <div class="touch-hint">Touch controls available on mobile</div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div class="muted">Maple · GBAcade UI</div>
        <div style="display:flex;gap:8px">
          <button id="openSettings" class="btn ghost">Emulator Settings</button>
        </div>
      </div>
    </main>

    <footer class="small">
      Emulator powered by EmulatorJS CDN (stable). Loader and cores come from the official CDN. No ROMs or BIOS supplied. :contentReference[oaicite:1]{index=1}
    </footer>
  </div>

  <script>
    // ---------- CONFIG ----------
    // Use the EmulatorJS CDN (stable). This removes the need to self-host emulator files.
    const EMULATORJS_DATA_CDN = 'https://cdn.emulatorjs.org/stable/data/';
    const EMULATORJS_LOADER = EMULATORJS_DATA_CDN + 'loader.js';

    // UI refs
    const fileIn = document.getElementById('fileIn');
    const pickBtn = document.getElementById('pickBtn');
    const dropzone = document.getElementById('dropzone');
    const selectedName = document.getElementById('selectedName');
    const loadBtn = document.getElementById('loadBtn');
    const gameTitle = document.getElementById('gameTitle');
    const statusSpan = document.getElementById('status');
    const volumeRange = document.getElementById('volume');
    const speedSelect = document.getElementById('speed');
    const screenshotBtn = document.getElementById('screenshotBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const openUiBtn = document.getElementById('openUiBtn');
    const openSettingsBtn = document.getElementById('openSettings');

    let romFile = null;
    let romBlobUrl = null;
    let loaderScriptEl = null;

    // Helpers
    function setStatus(s){ statusSpan.textContent = s; }

    function clearPreviousLoader(){
      // Attempt to remove previously loaded loader script and module objects
      if (loaderScriptEl) {
        loaderScriptEl.remove();
        loaderScriptEl = null;
      }
      // Try to cleanup global emulator variables exposed by EmulatorJS
      try {
        if (window.emulatorModule && window.emulatorModule.quit) {
          // attempt a graceful shutdown if available
          try { window.emulatorModule.quit(); } catch(e){}
        }
      } catch(e){}
      // Remove injected iframe-like player if any content was added
      const game = document.getElementById('game');
      game.innerHTML = ''; // wipe
      // Reset some globals the loader reads
      delete window.EJS_player;
      delete window.EJS_core;
      delete window.EJS_gameUrl;
      delete window.EJS_pathtodata;
      delete window.EJS_gameName;
      delete window.EJS_volume;
      delete window.EJS_startOnLoaded;
      // allow GC of blob url if present
      if (romBlobUrl) {
        try { URL.revokeObjectURL(romBlobUrl); } catch(e){}
        romBlobUrl = null;
      }
    }

    function injectLoaderOnce(){
      // add loader script (it will read global EJS_* variables)
      return new Promise((resolve, reject) => {
        loaderScriptEl = document.createElement('script');
        loaderScriptEl.src = EMULATORJS_LOADER + '?_=' + Date.now();
        loaderScriptEl.async = true;
        loaderScriptEl.onload = () => {
          setStatus('running');
          resolve();
        };
        loaderScriptEl.onerror = (e) => {
          setStatus('loader error');
          reject(new Error('Failed to load emulator loader'));
        };
        document.body.appendChild(loaderScriptEl);
        setStatus('loading core...');
      });
    }

    // Load the ROM (file chosen)
    async function startGame(){
      if (!romFile) {
        alert('Pick a ROM file first (a .gba or compatible archive).');
        return;
      }
      setStatus('preparing rom...');
      // clear previous instance if any
      clearPreviousLoader();

      // create blob url for ROM
      romBlobUrl = URL.createObjectURL(romFile);

      // Set EmulatorJS globals it expects before loader runs
      window.EJS_player = '#game';
      window.EJS_core = 'gba'; // use gba / mgba core
      window.EJS_gameUrl = romBlobUrl;
      window.EJS_pathtodata = EMULATORJS_DATA_CDN; // use CDN path for loader assets
      window.EJS_gameName = romFile.name.replace(/\.[^.]+$/, '');
      window.EJS_volume = parseFloat(volumeRange.value);
      window.EJS_startOnLoaded = true; // auto start when loaded

      // Speed control: many cores support multiplier via UI, but emulator may also accept EJS_videoSpeed
      // We provide a soft flag (not all cores use it). If supported, loader will pick it up.
      window.EJS_videoSpeed = parseFloat(speedSelect.value) || 1;

      // inject loader script which will mount emulator into #game
      try {
        await injectLoaderOnce();
      } catch (err) {
        console.error(err);
        alert('Could not start emulator. Check console for details.');
      }
    }

    // ---------- UI wiring ----------
    pickBtn.addEventListener('click', ()=> fileIn.click());
    dropzone.addEventListener('click', ()=> fileIn.click());

    fileIn.addEventListener('change', (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      romFile = f;
      selectedName.textContent = f.name;
      gameTitle.textContent = f.name;
      setStatus('ready to start');
    });

    // Drag & drop
    ['dragenter','dragover'].forEach(e => dropzone.addEventListener(e, (ev)=> { ev.preventDefault(); dropzone.style.borderColor = 'rgba(255,255,255,0.12)'; }));
    ['dragleave','drop'].forEach(e => dropzone.addEventListener(e, (ev)=> { ev.preventDefault(); dropzone.style.borderColor = ''; }));
    dropzone.addEventListener('drop', (ev) => {
      ev.preventDefault();
      const f = ev.dataTransfer && ev.dataTransfer.files && ev.dataTransfer.files[0];
      if (!f) return;
      romFile = f;
      selectedName.textContent = f.name;
      gameTitle.textContent = f.name;
      setStatus('ready to start');
    });

    loadBtn.addEventListener('click', startGame);

    // Fullscreen
    fullscreenBtn.addEventListener('click', async ()=>{
      const el = document.getElementById('gameArea');
      if (el.requestFullscreen) await el.requestFullscreen();
      else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
    });

    // Screenshot: attempt to call the emulator screenshot function if exposed, otherwise fallback to canvas capture
    screenshotBtn.addEventListener('click', async () => {
      // EmulatorJS provides its own screenshot feature in UI, but we try to call programmatically:
      try {
        if (window.emulatorModule && window.emulatorModule.do_screenshot) {
          // some builds expose a screenshot function
          window.emulatorModule.do_screenshot();
          alert('Screenshot requested via emulator (check UI/downloads).');
          return;
        }
      } catch(e){}

      // fallback: try to capture canvas inside #game
      try {
        const gameNode = document.querySelector('#game canvas');
        if (!gameNode) throw new Error('No canvas found');
        const data = gameNode.toDataURL('image/png');
        const a = document.createElement('a'); a.href = data; a.download = (window.EJS_gameName || 'gba-screenshot') + '.png'; a.click();
      } catch (err) {
        alert('Could not capture screenshot automatically. Use built-in emulator UI screenshot.');
      }
    });

    // Open emulator UI (if the loader created a UI toggle)
    openUiBtn.addEventListener('click', ()=>{
      // EmulatorJS creates a settings/menu button inside the player; we can try to simulate opening via class selectors.
      // If not present, advise user to use the on-screen UI.
      const openBtn = document.querySelector('#game .ejs-ui-toggle, #game [data-open-settings], .emulator-ui-toggle');
      if (openBtn) openBtn.click();
      else alert('Open the emulator UI using the in-frame menu (top-right of emulator area) after the emulator has loaded.');
    });

    // Open settings button tries to open virtual settings panel if exposed
    openSettingsBtn.addEventListener('click', ()=> openUiBtn.click());

    // Volume change updates global and attempts to inform running module
    volumeRange.addEventListener('input', ()=>{
      window.EJS_volume = parseFloat(volumeRange.value);
      // If emulator exposes an API to set volume, try it:
      try { if (window.emulatorModule && window.emulatorModule.setVolume) window.emulatorModule.setVolume(window.EJS_volume); } catch(e){}
    });

    // speed select
    speedSelect.addEventListener('change', ()=>{
      window.EJS_videoSpeed = parseFloat(speedSelect.value);
      try { if (window.emulatorModule && window.emulatorModule.setSpeed) window.emulatorModule.setSpeed(window.EJS_videoSpeed); } catch(e){}
    });

    // Safety: warn on navigation
    window.addEventListener('beforeunload', (e) => {
      if (window.EJS_gameUrl) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Expose a small helper for debugging in console
    window.MaplesGBA = {
      startGame, clearPreviousLoader,
      setRomFileFromBlob: (blob, name='game.gba') => {
        romFile = new File([blob], name, {type:'application/octet-stream'});
        selectedName.textContent = romFile.name;
        gameTitle.textContent = romFile.name;
      }
    };

    // Helpful hint printed to console
    console.info("Maple's GBAcade ready. Use the file picker or drag a .gba onto the drop area, then press Start Game.");
  </script>
</body>
</html>
