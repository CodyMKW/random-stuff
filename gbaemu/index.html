<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CodyBoy Advance â€” EmulatorJS GBA (Maple build)</title>
<link rel="icon" href="data:,ðŸŽ®" />
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1720; --accent:#ff6b6b; --muted:#9aa5b1;
    --glass: rgba(255,255,255,0.04);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    background:
      radial-gradient(1200px 400px at 10% 10%, rgba(255,107,107,0.06), transparent 8%),
      linear-gradient(180deg,#071018 0%, #071623 45%, #051018 100%);
    color:#e6eef6;
    -webkit-font-smoothing:antialiased;
    padding:24px;
    box-sizing:border-box;
  }
  header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:52px;height:52px;background:linear-gradient(135deg,#ff9a9e,#fecfef);border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#111}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}
  .layout{display:grid;grid-template-columns: 420px 1fr; gap:20px; align-items:start;}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px;padding:14px;box-shadow: 0 6px 18px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
  .controls .section{margin-bottom:12px}
  .dropzone{border:2px dashed rgba(255,255,255,0.04);padding:18px;border-radius:10px;text-align:center;cursor:pointer;background:var(--glass);}
  .muted{color:var(--muted);font-size:13px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;background:linear-gradient(90deg,var(--accent),#ffa77a);color:#07201a;font-weight:600;border:none;cursor:pointer;}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
  .flex{display:flex;gap:8px;align-items:center}
  .kbd{font-family:monospace;background:rgba(255,255,255,0.03);border-radius:6px;padding:6px 8px;font-size:12px;color:var(--muted)}
  .small{font-size:13px}
  #gameWrap{width:100%;height:520px;background:#000;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;position:relative}
  #game{width:100%;height:100%;}
  .meta{display:flex;justify-content:space-between;margin-top:10px;gap:8px;align-items:center}
  .info{color:var(--muted);font-size:13px}
  .slots{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .slot{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center;font-size:13px}
  .slot .title{font-weight:700;color:#fff}
  .save-list{max-height:160px;overflow:auto;padding:6px;border-radius:8px;border:1px dashed rgba(255,255,255,0.02)}
  label.fileish{display:inline-block;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
  footer{margin-top:18px;color:var(--muted);font-size:13px}
  .unhinge{ position:absolute; right:14px; top:12px; font-size:12px; color: #071018; background: #ffdede; padding:6px 8px; border-radius:20px; transform: rotate(-6deg); box-shadow: 0 6px 12px rgba(0,0,0,0.3)}
  .mapping{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:8px}
  .mapping .row{display:flex;justify-content:space-between;padding:6px;background:rgba(255,255,255,0.01);border-radius:6px;font-size:13px}
  .touchpad{display:none}
  @media (max-width:1100px){
    .layout{grid-template-columns:1fr; }
    #gameWrap{height:420px}
    .touchpad{display:block;margin-top:8px}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">CBA</div>
    <div>
      <h1>CodyBoy Advance â€” EmulatorJS (Maple build)</h1>
      <p class="lead">PokÃ©mon-friendly saves â€¢ Drag & Drop ROMs â€¢ Save-States â€¢ Pro controls</p>
    </div>
  </div>
  <div style="margin-left:auto;text-align:right">
    <div class="muted">Powered by <strong>EmulatorJS</strong></div>
    <div style="font-size:12px;color:var(--muted)">CDN: stable â€¢ Core: mGBA</div>
  </div>
</header>

<div class="layout">
  <!-- LEFT controls same as before -->
  <!-- RIGHT game panel same as before -->
</div>

<script>
const CDN_BASE = 'https://cdn.emulatorjs.org/stable/data/';
const LOADER_URL = CDN_BASE + 'loader.js';
let latestBatterySave = null;
let saveStateSlots = new Array(10).fill(null);

/* --- important save fix --- */
function persistSaveToLocal(hash, buf, name){
  try {
    localStorage.setItem("CBA_sav_" + hash, JSON.stringify({
      ts: Date.now(),
      name,
      b64: btoa(String.fromCharCode(...new Uint8Array(buf)))
    }));
  } catch(e){ console.warn("localStorage save failed", e); }
}
function loadSaveFromLocal(hash){
  const raw = localStorage.getItem("CBA_sav_" + hash);
  if(!raw) return null;
  try {
    const obj = JSON.parse(raw);
    const bin = Uint8Array.from(atob(obj.b64), c => c.charCodeAt(0));
    return {data: bin, name: obj.name};
  } catch(e){ return null; }
}

/* hook for EmulatorJS */
window.EJS_onSaveUpdate = function(payload){
  latestBatterySave = {
    hash: payload.hash,
    save: payload.save,
    name: (window._progba_lastName || 'game') + ".sav"
  };
  persistSaveToLocal(payload.hash, payload.save, latestBatterySave.name);
  console.log("Battery save updated + persisted", latestBatterySave.name);
};
window.EJS_ready = function(){
  const h = window.EJS_gameHash;
  const local = loadSaveFromLocal(h);
  if(local && window.EJS_module && window.EJS_module.writeSaveFiles){
    window.EJS_module.writeSaveFiles([{name: local.name, data: local.data}])
      .then(()=> console.log("Restored save from localStorage"))
      .catch(console.warn);
  }
};
/* --- end save fix --- */

/* load ROM normally */
function loadRomFile(file){
  const romUrl = URL.createObjectURL(file);
  window._progba_lastName = file.name.replace(/\.[^/.]+$/,"");
  window.EJS_player = "#game";
  window.EJS_core = "gba";
  window.EJS_gameUrl = romUrl;
  window.EJS_pathtodata = CDN_BASE;
  window.EJS_startOnLoaded = true;
  const s = document.createElement("script");
  s.src = LOADER_URL + "?_=" + Date.now();
  document.body.appendChild(s);
}
</script>
</body>
</html>
